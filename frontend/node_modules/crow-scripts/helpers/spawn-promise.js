const crossSpawn = require('cross-spawn')
const { execSync } = require('child_process')
const chalk = require('chalk')
const path = require('path')

const binPath = execSync(
  'npm bin',
  { cwd: __dirname }
).toString().trim()

const spawnOptions = {
  stdio: 'inherit',
  shell: true
}

const promisifySpawn = (spawn, command, args, options) => new Promise(
  (resolve, reject) => {
    const task = spawn(command, args, options)

    task.on('close', code => {
      if (code === 0) resolve(code)
      reject(code)
    })
  }
)

const spawnPromise = ({ bin, params }) => {
  console.log(chalk.grey(`$ ${bin} ${params.join(' ')}`))
  return promisifySpawn(
    crossSpawn,
    path.resolve(binPath, bin),
    params,
    spawnOptions
  )
}

module.exports = spawnPromise
